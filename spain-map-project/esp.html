<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="https://rawgit.com/markmarkoh/datamaps/master/dist/datamaps.world.js"></script>

    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
    <div class="container" style="width: 100%">
        <div class="row">
            <form>
                <input type="text" name="mes">
                <input type="submit" value="Visualizar">
            </form>
        </div>
        <div class="row">
            <div class="col-4" id="canary-islands" style="height: 700px; width: 500px"></div>
            <div class="col-10" id="esp" style="height: 950px; width: 1000px"></div>
        </div>
    </div>
    <script>
        function readJSON(url) {
            var json = $.Deferred();
            $.getJSON(url, function(json) {
                return json;
            }).done(function(data) {
                json.resolve(data)
            });
            return json;
        }

        function fill(min, max, value) {

        }
        var northPalette = d3.scale.linear()
            .domain([0.0000000000000, 100.0000000000000])
            .range(["#FFFDE7", "#FFEB3B"]);
        var mes = document.URL.split("=")[1];
        var meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        if (meses.includes(mes)) {
            readJSON("./assets/config.json").done(function(config) {
                readJSON("./data/" + mes + ".json").done(function(data) {
                    var dataset = {};
                    data.data.forEach(function(object, index) {
                        var iso = (JSON.stringify(object).split(":")[0].replace("{", "")).replace("\"", "").replace("\"", "");
                        var content = data.data[index][iso];
                        var palette = d3.scale.linear()
                            .domain([0.0000000000000, 100.0000000000000])
                            .range([config[content.fillKey].min, config[content.fillKey].max])
                        console.log(content);
                        dataset[iso] = {
                            fillKey: content.fillKey,
                            percentage: content.percentage,
                            fillColor: palette(content.percentage)
                        }
                    });
                    console.log(dataset);
                    var map = new Datamap({
                        element: document.getElementById('esp'),
                        scope: 'esp',
                        geographyConfig: {
                            popupOnHover: true,
                            fills: function(geo) {
                                return geo['fillColor'] || '#F5F5F5';
                            },
                            borderColor: '#444',
                            borderWidth: 0.5,
                            dataUrl: './assets/esp.topo.json',
                            popupTemplate: function(geo, data) {
                                if (!data) {
                                    return;
                                }
                                return ['<div class="hoverinfo">Porcentaje: ', data.percentage, '</div>'].join('');
                            }
                        },
                        data: dataset,
                        setProjection: function(element) {
                            var projection = d3.geo.mercator()
                                .center([-3.0, 42.433429]) // always in [East Latitude, North Longitude]
                                .scale(4000);
                            var path = d3.geo.path().projection(projection);
                            return {
                                path: path,
                                projection: projection
                            };
                        }
                    });
                })
            });

        } else {
            console.log("Valor incorrecto.");
        }
        /*
        var bubble_canary_islands_map = new Datamap({
            element: document.getElementById('canary-islands'),
            scope: 'canary-islands',
            geographyConfig: {
                popupOnHover: true,
                highlightOnHover: true,
                borderColor: '#444',
                borderWidth: 0.5,
                dataUrl: './assets/canary-islands.topo.json'
            },
            fills: {
                'CAN': '#F44336',
                defaultFill: '#dddddd'
            },
            data: {
                'CI': {
                    fillKey: 'CAN'
                }

            },
            setProjection: function(element) {
                var projection = d3.geo.mercator()
                    .center([-12, 32]) // always in [East Latitude, North Longitude]
                    .scale(4000);
                var path = d3.geo.path().projection(projection);
                return {
                    path: path,
                    projection: projection
                };
            }
        });

        
        isos.forEach(function(iso) {
            var color;
            if (dataset[iso].fillKey == 'NORTH') {
                color = northPalette(dataset[iso].percentage)
            } else if (dataset[iso].fillKey == 'SOUTH') {
                color = southPalette(dataset[iso].percentage)
            } else if (dataset[iso].fillKey == 'CENTER') {
                color = centerPalette(dataset[iso].percentage)
            } else if (dataset[iso].fillKey == 'EAST') {
                color = eastPalette(dataset[iso].percentage)
            } else if (dataset[iso].fillKey == 'CAT') {
                color = catPalette(dataset[iso].percentage)
            } else {
                color = canPalette(dataset[iso].percentage)
            }
            dataset[iso] = {
                fillKey: dataset[iso].fillKey,
                percentage: dataset[iso].percentage,
                fillColor: color
            }
        });
        console.log(dataset);
        var bubble_map */

    </script>
    <style>
        .row {
            display: auto;
        }

    </style>
</body>
