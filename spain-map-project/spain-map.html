<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
    <script src="assets/js/datamaps.world.js"></script>

    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link href="assets/css/main.css" rel="stylesheet">
</head>

<body>
    <div class="col-1">
        <input type="range" min="2008" max="2017" value="2008" class="slider" id="year-picker">
    </div>
    <h1 align="center">Accumulated percentage of optic feber</h1>
    <br>
    <div class="line">
        <input type="range" min="1" max="12" value="1" class="slider" id="picker-range">
    </div>
    <div class="line">
        <div style="width: 25%">Enero</div>
        <div style="width: 50%; text-align: center">Junio</div>
        <div style="width: 25%; text-align: right">Diciembre</div>
    </div>
    <div class="line">
        <div id="canary-islands" style="height: 700px; width: 500px"></div>
        <div id="peninsula-balears" style="height: 950px; width: 1000px"></div>
    </div>
    <script>
        function readJSON(url) {
            var json = $.Deferred();
            $.getJSON(url, function(json) {
                return json;
            }).done(function(data) {
                json.resolve(data)
            });
            return json;
        }

        function resetElement(element) {
            element.innerHTML = '';
        }
        function createMap(value) {
            var meses = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
            var mes = meses[value - 1];
            readJSON("./assets/config.json").done(function(config) {
                readJSON("./data/2015/" + mes + ".json").done(function(data) {
                    var dataset = {};
                    data.data.forEach(function(object, index) {
                        var iso = (JSON.stringify(object).split(":")[0].replace("{", "")).replace("\"", "").replace("\"", "");
                        var content = data.data[index][iso];
                        var palette = d3.scale.linear()
                            .domain([0.0000000000000, 100.0000000000000])
                            .range([config[content.fillKey].min, config[content.fillKey].max])
                        dataset[iso] = {
                            city: content.provincia,
                            fillKey: content.fillKey,
                            percentage: content.percentage_acc,
                            fillColor: palette(content.percentage_acc)
                        }
                    });
                    resetElement(document.getElementById('peninsula-balears'));
                    var peninsula_balears = new Datamap({
                        element: document.getElementById('peninsula-balears'),
                        scope: 'peninsula-balears',
                        geographyConfig: {
                            popupOnHover: true,
                            fills: function(geo) {
                                return geo['fillColor'] || '#F5F5F5';
                            },
                            borderColor: '#444',
                            borderWidth: 0.5,
                            dataUrl: './assets/peninsula-balears.topo.json',
                            popupTemplate: function(geo, data) {
                                if (!data) {
                                    return;
                                }
                                return ['<div class="hoverinfo">City: ', data.city, ' Porcentaje: ', data.percentage, '</div>'].join('');
                            }
                        },
                        data: dataset,
                        setProjection: function(element) {
                            var projection = d3.geo.mercator()
                                .center([-3.0, 42.433429]) // always in [East Latitude, North Longitude]
                                .scale(4000);
                            var path = d3.geo.path().projection(projection);
                            return {
                                path: path,
                                projection: projection
                            };
                        }
                    });
                    var canaryDataset = {
                        "LP": dataset["LP"],
                        "CT": dataset["CT"]
                    }
                    resetElement(document.getElementById('canary-islands'));
                    var canary_islands = new Datamap({
                        element: document.getElementById('canary-islands'),
                        scope: 'canary-islands',
                        geographyConfig: {
                            popupOnHover: true,
                            fills: function(geo) {
                                return geo['fillColor'] || '#F5F5F5';
                            },
                            borderColor: '#444',
                            borderWidth: 0.5,
                            dataUrl: './assets/canary-islands.topo.json',
                            popupTemplate: function(geo, data) {
                                if (!data) {
                                    return;
                                }
                                return ['<div class="hoverinfo">City: ', data.city, ' Porcentaje: ', data.percentage, '</div>'].join('');
                            }
                        },
                        data: canaryDataset,
                        setProjection: function(element) {
                            var projection = d3.geo.mercator()
                                .center([-12, 32]) // always in [East Latitude, North Longitude]
                                .scale(4000);
                            var path = d3.geo.path().projection(projection);
                            return {
                                path: path,
                                projection: projection
                            };
                        }
                    });
                })
            });
        }
        var slider = document.getElementById("picker-range");
        if (slider.value == 1) {
            this.createMap(slider.value);
        }
        slider.oninput = function() {
            createMap(this.value);
        };

    </script>
    <style>
        .row {
            display: auto;
        }
        
        .container {
            margin-left: 300px;
        }
    </style>
</body>
